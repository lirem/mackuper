{% extends "base.html" %}

{% block title %}Dashboard - Mackuper{% endblock %}

{% block body %}
<div x-data="mackuperApp()" x-init="init()" class="min-h-screen">
    <!-- Top Navigation Bar -->
    <nav class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-800">Mackuper</h1>
                    <span class="ml-3 text-sm text-gray-500">Backup Management</span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Scheduler Status -->
                    <div class="flex items-center space-x-2">
                        <div :class="schedulerRunning ? 'bg-green-500' : 'bg-red-500'"
                             class="w-2 h-2 rounded-full"></div>
                        <span class="text-sm text-gray-600" x-text="schedulerRunning ? 'Scheduler Active' : 'Scheduler Stopped'"></span>
                    </div>

                    <!-- User Menu -->
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">{{ current_user.username }}</span>
                        <a href="{{ url_for('auth.logout') }}"
                           class="text-sm text-gray-600 hover:text-gray-900">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="-mb-px flex space-x-8">
                <button @click="currentTab = 'dashboard'"
                        :class="currentTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Dashboard
                </button>
                <button @click="currentTab = 'jobs'"
                        :class="currentTab === 'jobs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Backup Jobs
                </button>
                <button @click="currentTab = 'history'"
                        :class="currentTab === 'history' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    History
                </button>
                <button @click="currentTab = 'settings'"
                        :class="currentTab === 'settings' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Settings
                </button>
            </nav>
        </div>

        <!-- Toast Notifications -->
        <div x-show="toast.show"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed top-4 right-4 z-50 max-w-sm">
            <div :class="{
                'bg-green-50 border-green-200 text-green-800': toast.type === 'success',
                'bg-red-50 border-red-200 text-red-800': toast.type === 'error',
                'bg-blue-50 border-blue-200 text-blue-800': toast.type === 'info'
            }" class="border rounded-lg p-4 shadow-lg">
                <p class="text-sm font-medium" x-text="toast.message"></p>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Dashboard Tab -->
            <div x-show="currentTab === 'dashboard'" class="space-y-6">
                <!-- Update Badge -->
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <div class="w-2 h-2 rounded-full bg-green-500"
                         x-show="isRefreshing"
                         x-transition></div>
                    <span x-text="'Updated ' + formatRelativeTime(lastDashboardRefresh)"></span>
                </div>

                <!-- Overview Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="stat-card">
                        <div class="stat-label">Total Jobs</div>
                        <div class="stat-value" x-text="dashboardData.overview.total_jobs"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Jobs</div>
                        <div class="stat-value" x-text="dashboardData.overview.active_jobs"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Last Backup</div>
                        <div class="stat-value text-lg" x-text="formatRelativeTime(dashboardData.overview.last_backup?.completed_at)"></div>
                        <div class="stat-change">
                            <span x-show="dashboardData.overview.last_backup?.status"
                                  :class="'badge ' + getStatusBadgeClass(dashboardData.overview.last_backup?.status)"
                                  x-text="dashboardData.overview.last_backup?.status"></span>
                            <span x-show="!dashboardData.overview.last_backup">No backups yet</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Scheduler</div>
                        <div class="stat-value text-lg" x-text="dashboardData.overview.scheduler_running ? 'Running' : 'Stopped'"></div>
                        <div class="stat-change">
                            <span :class="dashboardData.overview.scheduler_running ? 'text-green-600' : 'text-red-600'"
                                  x-text="dashboardData.overview.scheduler_running ? '● Active' : '● Inactive'"></span>
                        </div>
                    </div>
                </div>

                <!-- Overall Statistics -->
                <div class="card">
                    <h2 class="card-header">Overall Statistics</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Total Backups</p>
                            <p class="text-2xl font-semibold" x-text="dashboardData.statistics.total_backups || 0"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Success Rate</p>
                            <p class="text-2xl font-semibold" x-text="(dashboardData.statistics.success_rate || 0) + '%'"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Total Size</p>
                            <p class="text-2xl font-semibold" x-text="formatBytes(dashboardData.statistics.total_size || 0)"></p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h2 class="card-header">Recent Activity</h2>
                    <div x-show="dashboardData.recentActivity.length === 0" class="empty-state">
                        <p class="empty-state-text">No backup history yet</p>
                        <p class="empty-state-subtext">Create a backup job to get started</p>
                    </div>
                    <div x-show="dashboardData.recentActivity.length > 0" class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Job Name</th>
                                    <th>Status</th>
                                    <th>Started</th>
                                    <th>Duration</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="item in dashboardData.recentActivity" :key="item.id">
                                    <tr>
                                        <td class="font-medium" x-text="item.job_name"></td>
                                        <td>
                                            <span :class="'badge ' + getStatusBadgeClass(item.status)"
                                                  x-text="item.status"></span>
                                        </td>
                                        <td class="text-gray-600" x-text="formatRelativeTime(item.started_at)"></td>
                                        <td class="text-gray-600"
                                            x-text="item.completed_at && item.started_at ? Math.round((new Date(item.completed_at) - new Date(item.started_at)) / 1000) + 's' : '-'"></td>
                                        <td class="text-gray-600" x-text="item.file_size_bytes ? formatBytes(item.file_size_bytes) : '-'"></td>
                                        <td>
                                            <button x-show="item.status === 'running' || item.status === 'cancelling'"
                                                    @click="cancelBackupFromDashboard(item.id)"
                                                    class="btn-secondary btn-sm"
                                                    :disabled="item.status === 'cancelling'"
                                                    x-text="item.status === 'cancelling' ? 'Cancelling...' : 'Cancel'">
                                            </button>
                                            <span x-show="item.status !== 'running' && item.status !== 'cancelling'">-</span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h2 class="card-header">Quick Actions</h2>
                    <div class="flex gap-4">
                        <button @click="currentTab = 'jobs'" class="btn-primary">
                            Create Backup Job
                        </button>
                        <button @click="currentTab = 'history'" class="btn-secondary">
                            View All History
                        </button>
                    </div>
                </div>
            </div>

            <!-- Jobs Tab -->
            <div x-show="currentTab === 'jobs'" x-html="jobsHtml"></div>

            <!-- History Tab -->
            <div x-show="currentTab === 'history'" class="space-y-6">
                <!-- Header -->
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Backup History</h1>
                        <div class="flex items-center gap-2 text-sm text-gray-500 mt-1">
                            <div class="w-2 h-2 rounded-full bg-green-500"
                                 x-show="isRefreshing"
                                 x-transition></div>
                            <span x-text="'Updated ' + formatRelativeTime(lastHistoryRefresh)"></span>
                        </div>
                    </div>
                    <button @click="showCleanupDialog()" class="btn-secondary btn-sm">
                        Cleanup Old Records
                    </button>
                </div>

                <!-- Filters -->
                <div class="card">
                    <h2 class="text-sm font-semibold text-gray-700 mb-3">Filters</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="form-label">Status</label>
                            <select class="form-select" @change="updateFilter('status', $event.target.value)">
                                <option value="">All</option>
                                <option value="success" :selected="historyData.filters.status === 'success'">Success</option>
                                <option value="failed" :selected="historyData.filters.status === 'failed'">Failed</option>
                                <option value="running" :selected="historyData.filters.status === 'running'">Running</option>
                                <option value="cancelling" :selected="historyData.filters.status === 'cancelling'">Cancelling</option>
                                <option value="cancelled" :selected="historyData.filters.status === 'cancelled'">Cancelled</option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">Job</label>
                            <select class="form-select" @change="updateFilter('job_id', $event.target.value)">
                                <option value="">All Jobs</option>
                                <template x-for="job in historyData.jobs" :key="job.id">
                                    <option :value="job.id" :selected="historyData.filters.job_id == job.id" x-text="job.name"></option>
                                </template>
                            </select>
                        </div>

                        <div>
                            <label class="form-label">Time Range</label>
                            <select class="form-select" @change="updateFilter('days', $event.target.value)">
                                <option value="1" :selected="historyData.filters.days == 1">Last 24 hours</option>
                                <option value="7" :selected="historyData.filters.days == 7">Last 7 days</option>
                                <option value="30" :selected="historyData.filters.days == 30">Last 30 days</option>
                                <option value="90" :selected="historyData.filters.days == 90">Last 90 days</option>
                                <option value="" :selected="historyData.filters.days === ''">All time</option>
                            </select>
                        </div>

                        <div class="flex items-end">
                            <button @click="resetFilters()" class="btn-secondary w-full">
                                Reset Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div x-show="historyData.records.length === 0" class="card">
                    <div class="empty-state">
                        <p class="empty-state-text">No backup history found</p>
                        <p class="empty-state-subtext">No backups match the selected filters</p>
                    </div>
                </div>

                <div x-show="historyData.records.length > 0" class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Job Name</th>
                                    <th>Status</th>
                                    <th>Started</th>
                                    <th>Completed</th>
                                    <th>Duration</th>
                                    <th>Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="item in historyData.records" :key="item.id">
                                    <tr>
                                        <td class="font-medium" x-text="getJobName(item.job_id, historyData.jobs)"></td>
                                        <td>
                                            <span :class="'badge ' + getStatusBadgeClass(item.status)"
                                                  x-text="item.status"></span>
                                        </td>
                                        <td class="text-sm text-gray-600" x-text="formatDate(item.started_at)"></td>
                                        <td class="text-sm text-gray-600" x-text="item.completed_at ? formatDate(item.completed_at) : '-'"></td>
                                        <td class="text-sm text-gray-600"
                                            x-text="calculateDuration(item.started_at, item.completed_at) ? calculateDuration(item.started_at, item.completed_at) + 's' : '-'"></td>
                                        <td class="text-sm text-gray-600" x-text="item.file_size_bytes ? formatBytes(item.file_size_bytes) : '-'"></td>
                                        <td>
                                            <div class="flex gap-2">
                                                <button x-show="item.status === 'running' || item.status === 'cancelling'"
                                                        @click="cancelBackup(item.id)"
                                                        class="btn-secondary btn-sm"
                                                        :disabled="item.status === 'cancelling'"
                                                        x-text="item.status === 'cancelling' ? 'Cancelling...' : 'Cancel'">
                                                </button>
                                                <button @click="viewLogs(item.id)" class="btn-secondary btn-sm">
                                                    View Logs
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div x-show="currentTab === 'settings'" x-html="settingsHtml"></div>
        </div>
    </div>

    <!-- Global Modals (Outside Tab Content) -->
    <!-- History Logs Modal -->
    <div x-show="historyModalOpen"
         @click.self="historyModalOpen = false"
         class="modal-overlay"
         style="display: none;"
         x-transition>
        <div class="modal-content max-w-4xl">
            <div x-html="historyModalContent"></div>
        </div>
    </div>
</div>

<!-- Load component scripts -->
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/jobs.js') }}"></script>
<script src="{{ url_for('static', filename='js/history.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}
